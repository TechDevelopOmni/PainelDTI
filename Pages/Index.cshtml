@page
@using System.Text.Json
@model PainelDTI.Pages.IndexModel
@{
    ViewData["Title"] = "Principal";
    var producaoDiaJson = JsonSerializer.Serialize(Model.ProducaoPorDia.Select(x => new { label = x.Dia, value = x.Valor }));
    var acumuladoJson = JsonSerializer.Serialize(Model.ProducaoAcumuladaMensal.Select(x => new { label = x.Mes, value = x.Acumulado }));
    var cedentesJson = JsonSerializer.Serialize(Model.CedentesTop10.Select(x => new { label = x.Cedente, value = x.Valor }));
    var carteiraJson = JsonSerializer.Serialize(Model.Carteira.Select(x => new { label = x.Nome, value = x.Valor }));
}

<h1>Painel Executivo Trimestral</h1>
<p>Dados simulados para MVP atÃ© integraÃ§Ã£o com backend WBA/API.</p>

<section class="dash-section">
    <h2>ğŸŸ¦ Bloco 1 â€” VisÃ£o Geral</h2>
    <div class="kpi-grid">
        <article class="card kpi-main"><h3>ğŸ¯ Meta do Trimestre</h3><strong>@Model.MetaTrimestre.ToString("C0")</strong></article>
        <article class="card kpi-main"><h3>ğŸ“ˆ ProduÃ§Ã£o Realizada (MTD)</h3><strong>@Model.ProducaoMtd.ToString("C0")</strong></article>
        <article class="card kpi-main"><h3>ğŸ“Š % Atingimento da Meta</h3><strong>@Model.AtingimentoMeta%</strong></article>
        <article class="card kpi-main"><h3>ğŸ”® ProjeÃ§Ã£o Final do Trimestre</h3><strong>@Model.ProjecaoTrimestre.ToString("C0")</strong></article>
        <article class="card kpi-main"><h3>âš ï¸ Gap para Meta</h3><strong>@Model.GapMeta.ToString("C0")</strong></article>
    </div>
</section>

<section class="dash-section">
    <h2>ğŸŸ¦ Bloco 2 â€” ProduÃ§Ã£o Operacional (RelatÃ³rio 1)</h2>
    <p>Fonte alvo: Gerencia &gt; OperaÃ§Ãµes &gt; C. PrÃ³pria &gt; AquisiÃ§Ãµes no PerÃ­odo (Resumo).</p>
    <div class="chart-grid">
        <article class="card"><h3>ğŸ“… ProduÃ§Ã£o por Dia</h3><canvas id="chartProducaoDia"></canvas></article>
        <article class="card"><h3>ğŸ“† ProduÃ§Ã£o Acumulada</h3><canvas id="chartAcumulado"></canvas></article>
        <article class="card"><h3>ğŸ“Š Comparativo Meta x Real</h3><canvas id="chartMetaReal"></canvas></article>
        <article class="card"><h3>ğŸ”„ MÃ©dia diÃ¡ria necessÃ¡ria</h3><p class="highlight-value">@Model.MediaNecessariaDiaria.ToString("C0") por dia Ãºtil</p></article>
    </div>
</section>

<section class="dash-section">
    <h2>ğŸŸ¦ Bloco 3 â€” ProjeÃ§Ã£o Financeira (RelatÃ³rio 2)</h2>
    <p>Fonte alvo: Contas &gt; Cedente &gt; Mapa de Contas a Receber.</p>
    <div class="kpi-grid finance-grid">
        @foreach (var item in Model.Carteira)
        {
            <article class="card"><h3>@item.Nome</h3><strong>@item.Valor.ToString("C0")</strong></article>
        }
        <article class="card"><h3>% InadimplÃªncia</h3><strong>@Model.InadimplenciaPercentual%</strong></article>
    </div>
    <article class="card"><h3>Status da carteira</h3><canvas id="chartCarteira"></canvas></article>
</section>

<section class="dash-section">
    <h2>ğŸŸ¦ Bloco 4 â€” ConcentraÃ§Ã£o por Cedente</h2>
    <div class="chart-grid">
        <article class="card"><h3>Pareto 80/20</h3><canvas id="chartPareto"></canvas></article>
        <article class="card"><h3>Top 10 Cedentes</h3><canvas id="chartTopCedentes"></canvas></article>
        <article class="card">
            <h3>Heatmap de concentraÃ§Ã£o</h3>
            <div class="heatmap-grid">
                @foreach (var cedente in Model.CedentesTop10)
                {
                    var participacao = Math.Round((cedente.Valor / Model.CedentesTop10.Sum(x => x.Valor)) * 100, 1);
                    var css = participacao switch
                    {
                        > 25 => "risk-red",
                        > 15 => "risk-yellow",
                        > 5 => "risk-green",
                        _ => "risk-blue"
                    };
                    <div class="heatmap-item @css">@cedente.Cedente <small>@participacao%</small></div>
                }
            </div>
        </article>
    </div>
</section>

<section class="dash-section">
    <h2>Estrutura TÃ©cnica e EvoluÃ§Ã£o</h2>
    <div class="card-grid">
        <article class="card"><h3>Passo crÃ­tico</h3><p>Confirmar se o WBA possui API para conexÃ£o direta e atualizaÃ§Ã£o automÃ¡tica.</p></article>
        <article class="card"><h3>OpÃ§Ã£o rÃ¡pida (15 dias)</h3><p>ExtraÃ§Ã£o CSV diÃ¡ria + banco intermediÃ¡rio + Power BI + link privado.</p></article>
        <article class="card"><h3>OpÃ§Ã£o estratÃ©gica DTI</h3><p>Backend prÃ³prio (Node/.NET), conector WBA, SQL, dashboard web com usuÃ¡rios e alertas.</p></article>
        <article class="card"><h3>5 respostas da diretoria</h3><p>Ritmo do trimestre, mÃ©dia diÃ¡ria, mÃ©dia necessÃ¡ria, risco da carteira e concentraÃ§Ã£o perigosa.</p></article>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const producaoDia = @Html.Raw(producaoDiaJson);
    const acumulado = @Html.Raw(acumuladoJson);
    const cedentes = @Html.Raw(cedentesJson);
    const carteira = @Html.Raw(carteiraJson);

    const currency = value => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 }).format(value);

    new Chart(document.getElementById('chartProducaoDia'), {
        type: 'line',
        data: { labels: producaoDia.map(x => x.label), datasets: [{ label: 'ProduÃ§Ã£o diÃ¡ria', data: producaoDia.map(x => x.value), borderColor: '#0f766e', tension: .3, fill: false }] }
    });

    new Chart(document.getElementById('chartAcumulado'), {
        type: 'bar',
        data: { labels: acumulado.map(x => x.label), datasets: [{ label: 'Acumulado', data: acumulado.map(x => x.value), backgroundColor: '#2563eb' }] },
        options: { plugins: { tooltip: { callbacks: { label: ctx => currency(ctx.parsed.y) } } } }
    });

    new Chart(document.getElementById('chartMetaReal'), {
        type: 'bar',
        data: {
            labels: ['Trimestre'],
            datasets: [
                { label: 'Meta', data: [1200000], backgroundColor: '#f59e0b' },
                { label: 'Real MTD', data: [producaoDia.reduce((acc, item) => acc + item.value, 0)], backgroundColor: '#16a34a' }
            ]
        }
    });

    new Chart(document.getElementById('chartCarteira'), {
        type: 'doughnut',
        data: { labels: carteira.map(x => x.label), datasets: [{ data: carteira.map(x => x.value), backgroundColor: ['#0ea5e9', '#f59e0b', '#dc2626'] }] }
    });

    const totalCedentes = cedentes.reduce((acc, item) => acc + item.value, 0);
    let cumulativo = 0;
    const pareto = cedentes.map(item => {
        cumulativo += item.value;
        return Math.round((cumulativo / totalCedentes) * 1000) / 10;
    });

    new Chart(document.getElementById('chartPareto'), {
        data: {
            labels: cedentes.map(x => x.label),
            datasets: [
                { type: 'bar', label: 'Valor por cedente', data: cedentes.map(x => x.value), backgroundColor: '#334155' },
                { type: 'line', label: 'Acumulado %', data: pareto, borderColor: '#dc2626', yAxisID: 'y1' }
            ]
        },
        options: {
            scales: {
                y: { beginAtZero: true },
                y1: { beginAtZero: true, position: 'right', max: 100, grid: { drawOnChartArea: false } }
            }
        }
    });

    new Chart(document.getElementById('chartTopCedentes'), {
        type: 'bar',
        data: { labels: cedentes.map(x => x.label), datasets: [{ label: 'Saldo', data: cedentes.map(x => x.value), backgroundColor: '#0891b2' }] },
        options: { indexAxis: 'y' }
    });
</script>
